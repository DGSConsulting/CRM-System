<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced CRM System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #9CAF88 0%, #6B8E5A 100%);
            min-height: 100vh;
            color: #333;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            margin: 0 5px;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: linear-gradient(135deg, #9CAF88 0%, #9CAF88 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #4A5D23;
        }

        .form-section h3 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ffffff;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ffffff;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4A5D23;
            box-shadow: 0 0 10px rgba(74, 93, 35, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #9CAF88 0%, #6B8E5A 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
        }

        .contacts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .contact-card {
            background: linear-gradient(135deg, #9CAF88 0%, #6B8E5A 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid #4A5D23;
            position: relative;
            transition: all 0.3s ease;
        }

        .contact-card:hover {
            transform: translateY(-5px);
        }

        .contact-card h4 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .contact-info {
            color: #ffffff;
            margin-bottom: 8px;
        }

        .contact-info strong {
            color: #ffffff;
            margin-right: 8px;
            min-width: 80px;
        }

        .contact-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #9CAF88 0%, #6B8E5A 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            color: white;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .search-bar {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.9);
        }

        .filters-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .task-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #9CAF88;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .task-item.completed {
            opacity: 0.7;
            border-left-color: #00b894;
        }

        .task-item.overdue {
            border-left-color: #e74c3c;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-meta {
            font-size: 0.9em;
            color: #666;
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .priority-high { border-left-color: #e74c3c !important; }
        .priority-medium { border-left-color: #f39c12 !important; }
        .priority-low { border-left-color: #2ecc71 !important; }

        .deal-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .deal-stage {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stage-lead { background: #ff6b6b; }
        .stage-qualified { background: #4ecdc4; }
        .stage-proposal { background: #45b7d1; }
        .stage-negotiation { background: #f9ca24; color: #333; }
        .stage-closed-won { background: #6c5ce7; }
        .stage-closed-lost { background: #a0a0a0; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #9CAF88 0%, #6B8E5A 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .notification.error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .notification.success {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1e1e2f 0%, #2c2c3e 100%);
            color: #f5f5f5;
        }

        body.dark-mode .tab-content {
            background: #2c2c3e;
            color: #fff;
        }

        body.dark-mode .contact-card {
            background: #3a3a4e;
            color: #fff;
        }

        body.dark-mode .stat-card {
            background: #3a3a4e;
            color: #fff;
        }

        body.dark-mode .search-bar {
            background: #2c2c3e;
            color: #fff;
            border-color: #555;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea {
            background: #2c2c3e;
            color: #fff;
            border-color: #555;
        }

        body.dark-mode .task-item {
            background: #3a3a4e;
            color: #fff;
        }

        body.dark-mode .filter-group label {
            color: #fff;
        }

        body.dark-mode .filter-group select {
            background: #3a3a4e;
            color: #fff;
            border-color: #555;
        }

        body.dark-mode .empty-state {
            color: #ccc;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .nav-tab {
                margin: 2px 0;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .contacts-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-container {
                flex-direction: column;
                align-items: stretch;
            }

            .task-item {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .task-actions {
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enhanced CRM System</h1>
            <p>Manage your contacts, deals, tasks, and business growth efficiently</p>
            <button onclick="toggleDarkMode()" class="btn btn-secondary" style="margin-top: 15px;">
                Toggle Dark Mode
            </button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab(event, 'dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab(event, 'contacts')">Contacts</button>
            <button class="nav-tab" onclick="showTab(event, 'add-contact')">Add Contact</button>
            <button class="nav-tab" onclick="showTab(event, 'tasks')">Tasks</button>
            <button class="nav-tab" onclick="showTab(event, 'deals')">Deals</button>
            <button class="nav-tab" onclick="showTab(event, 'analytics')">Analytics</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-contacts">0</div>
                    <div class="stat-label">Total Contacts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-leads">0</div>
                    <div class="stat-label">Active Leads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-customers">0</div>
                    <div class="stat-label">Customers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-tasks">0</div>
                    <div class="stat-label">Pending Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-deals">0</div>
                    <div class="stat-label">Active Deals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-deal-value">$0</div>
                    <div class="stat-label">Pipeline Value</div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Recent Activity</h3>
                <div id="recent-activity">
                    <div class="empty-state">
                        <h3>No recent activity</h3>
                        <p>Start by adding some contacts or creating tasks!</p>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Quick Actions</h3>
                <div class="filters-container">
                    <button class="btn" onclick="showTab(event, 'add-contact')">Add Contact</button>
                    <button class="btn btn-secondary" onclick="showTab(event, 'tasks')">Add Task</button>
                    <button class="btn btn-success" onclick="showTab(event, 'deals')">Create Deal</button>
                    <button class="btn btn-warning" onclick="exportData()">Export Data</button>
                </div>
            </div>
        </div>

        <!-- Contacts Tab -->
        <div id="contacts" class="tab-content">
            <input type="text" class="search-bar" id="search-contacts" placeholder="Search contacts..." oninput="filterContacts()">
            
            <div class="filters-container">
                <div class="filter-group">
                    <label>Status Filter:</label>
                    <select id="status-filter" onchange="filterContacts()">
                        <option value="">All Statuses</option>
                        <option value="lead">Lead</option>
                        <option value="prospect">Prospect</option>
                        <option value="customer">Customer</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Sort By:</label>
                    <select id="sort-contacts" onchange="sortContacts()">
                        <option value="name">Name</option>
                        <option value="company">Company</option>
                        <option value="date">Date Added</option>
                        <option value="status">Status</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="exportContacts()">Export CSV</button>
            </div>
            
            <div class="contacts-grid" id="contacts-grid">
                <div class="empty-state">
                    <h3>No contacts yet</h3>
                    <p>Add your first contact to get started!</p>
                    <button class="btn" onclick="showTab(event, 'add-contact')">Add Contact</button>
                </div>
            </div>
        </div>

        <!-- Add Contact Tab -->
        <div id="add-contact" class="tab-content">
            <div class="form-section">
                <h3>Contact Information</h3>
                <form id="contact-form">
                    <div class="form-grid">
                        <div>
                            <div class="form-group">
                                <label for="firstName">First Name *</label>
                                <input type="text" id="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name *</label>
                                <input type="text" id="lastName" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email *</label>
                                <input type="email" id="email" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone</label>
                                <input type="tel" id="phone">
                            </div>
                            <div class="form-group">
                                <label for="linkedin">LinkedIn URL</label>
                                <input type="url" id="linkedin" placeholder="https://linkedin.com/in/username">
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label for="company">Company</label>
                                <input type="text" id="company">
                            </div>
                            <div class="form-group">
                                <label for="position">Position</label>
                                <input type="text" id="position">
                            </div>
                            <div class="form-group">
                                <label for="status">Status *</label>
                                <select id="status" required>
                                    <option value="lead">Lead</option>
                                    <option value="prospect">Prospect</option>
                                    <option value="customer">Customer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="source">Lead Source</label>
                                <select id="source">
                                    <option value="">Select Source</option>
                                    <option value="website">Website</option>
                                    <option value="referral">Referral</option>
                                    <option value="social-media">Social Media</option>
                                    <option value="advertisement">Advertisement</option>
                                    <option value="event">Event</option>
                                    <option value="cold-outreach">Cold Outreach</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tags">Tags (comma-separated)</label>
                                <input type="text" id="tags" placeholder="VIP, decision-maker, hot-lead">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" rows="3" placeholder="Add notes about this contact..."></textarea>
                    </div>
                    <button type="submit" class="btn">Save Contact</button>
                    <button type="reset" class="btn btn-secondary">Reset Form</button>
                </form>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks" class="tab-content">
            <div class="form-section">
                <h3>Add New Task</h3>
                <form id="task-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="task-title">Task Title *</label>
                            <input type="text" id="task-title" required>
                        </div>
                        <div class="form-group">
                            <label for="task-contact">Related Contact</label>
                            <select id="task-contact">
                                <option value="">Select Contact</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="task-deal">Related Deal</label>
                            <select id="task-deal">
                                <option value="">Select Deal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="task-type">Task Type</label>
                            <select id="task-type">
                                <option value="call">Call</option>
                                <option value="email">Email</option>
                                <option value="meeting">Meeting</option>
                                <option value="follow-up">Follow-up</option>
                                <option value="proposal">Proposal</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="task-priority">Priority</label>
                            <select id="task-priority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="task-due">Due Date</label>
                            <input type="date" id="task-due">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="task-description">Description</label>
                        <textarea id="task-description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">Add Task</button>
                </form>
            </div>

            <div class="filters-container">
                <div class="filter-group">
                    <label>Filter Tasks:</label>
                    <select id="task-filter" onchange="filterTasks()">
                        <option value="all">All Tasks</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="overdue">Overdue</option>
                        <option value="today">Due Today</option>
                    </select>
                </div>
            </div>

            <div id="tasks-list">
                <div class="empty-state">
                    <h3>No tasks yet</h3>
                    <p>Create your first task to stay organized!</p>
                </div>
            </div>
        </div>

        <!-- Deals Tab -->
        <div id="deals" class="tab-content">
            <div class="form-section">
                <h3>Add New Deal</h3>
                <form id="deal-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="deal-title">Deal Title *</label>
                            <input type="text" id="deal-title" required>
                        </div>
                        <div class="form-group">
                            <label for="deal-contact">Primary Contact *</label>
                            <select id="deal-contact" required>
                                <option value="">Select Contact</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deal-value">Deal Value ($)</label>
                            <input type="number" id="deal-value" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="deal-stage">Stage *</label>
                            <select id="deal-stage" required>
                                <option value="lead">Lead</option>
                                <option value="qualified">Qualified</option>
                                <option value="proposal">Proposal</option>
                                <option value="negotiation">Negotiation</option>
                                <option value="closed-won">Closed Won</option>
                                <option value="closed-lost">Closed Lost</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deal-probability">Probability (%)</label>
                            <input type="number" id="deal-probability" min="0" max="100" value="50">
                        </div>
                        <div class="form-group">
                            <label for="deal-close-date">Expected Close Date</label>
                            <input type="date" id="deal-close-date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="deal-description">Description</label>
                        <textarea id="deal-description" rows="3" placeholder="Deal details..."></textarea>
                    </div>
                    <button type="submit" class="btn">Create Deal</button>
                </form>
            </div>

            <div id="deals-list">
                <div class="empty-state">
                    <h3>No deals yet</h3>
                    <p>Create your first deal to track your sales pipeline!</p>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="form-section">
                <h3>Business Analytics</h3>
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="conversion-rate">0%</div>
                        <div class="stat-label">Lead to Customer</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-deal-value">$0</div>
                        <div class="stat-label">Avg Deal Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="tasks-completed">0%</div>
                        <div class="stat-label">Tasks Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="deals-won">0%</div>
                        <div class="stat-label">Deal Win Rate</div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Lead Sources</h3>
                <div id="lead-sources-chart">
                    <div class="empty-state">
                        <p>Add contacts with lead sources to see analytics here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Data storage
        let contacts = [];
        let tasks = [];
        let deals = [];
        let currentContactId = 1;
        let currentTaskId = 1;
        let currentDealId = 1;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateDashboard();
            updateContactsDisplay();
            updateTasksDisplay();
            updateDealsDisplay();
            updateAnalytics();
            populateContactSelects();
            
            // Load dark mode preference
            if (localStorage.getItem('crmDarkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
        });

        // Tab management
        function showTab(event, tabName) {
            // Hide all tab contents
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Update displays when switching to certain tabs
            if (tabName === 'contacts') {
                updateContactsDisplay();
            } else if (tabName === 'tasks') {
                updateTasksDisplay();
            } else if (tabName === 'deals') {
                updateDealsDisplay();
            } else if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'analytics') {
                updateAnalytics();
            }
        }

        // Contact management
        document.getElementById('contact-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const contact = {
                id: currentContactId++,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                linkedin: document.getElementById('linkedin').value,
                company: document.getElementById('company').value,
                position: document.getElementById('position').value,
                status: document.getElementById('status').value,
                source: document.getElementById('source').value,
                tags: document.getElementById('tags').value,
                notes: document.getElementById('notes').value,
                dateAdded: new Date().toISOString(),
                lastInteraction: new Date().toISOString()
            };
            
            contacts.push(contact);
            saveData();
            updateDashboard();
            updateContactsDisplay();
            populateContactSelects();
            
            // Reset form and show success message
            this.reset();
            showNotification('Contact added successfully!', 'success');
            
            // Switch to contacts tab
            showTab({ target: document.querySelector('.nav-tab[onclick*="contacts"]') }, 'contacts');
        });

        // Task management
        document.getElementById('task-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const task = {
                id: currentTaskId++,
                title: document.getElementById('task-title').value,
                contactId: document.getElementById('task-contact').value,
                dealId: document.getElementById('task-deal').value,
                type: document.getElementById('task-type').value,
                priority: document.getElementById('task-priority').value,
                dueDate: document.getElementById('task-due').value,
                description: document.getElementById('task-description').value,
                completed: false,
                dateCreated: new Date().toISOString()
            };
            
            tasks.push(task);
            saveData();
            updateDashboard();
            updateTasksDisplay();
            
            // Reset form and show success message
            this.reset();
            showNotification('Task added successfully!', 'success');
        });

        // Deal management
        document.getElementById('deal-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const deal = {
                id: currentDealId++,
                title: document.getElementById('deal-title').value,
                contactId: document.getElementById('deal-contact').value,
                value: parseFloat(document.getElementById('deal-value').value) || 0,
                stage: document.getElementById('deal-stage').value,
                probability: parseInt(document.getElementById('deal-probability').value) || 50,
                closeDate: document.getElementById('deal-close-date').value,
                description: document.getElementById('deal-description').value,
                dateCreated: new Date().toISOString()
            };
            
            deals.push(deal);
            saveData();
            updateDashboard();
            updateDealsDisplay();
            
            // Reset form and show success message
            this.reset();
            showNotification('Deal created successfully!', 'success');
        });

        // Data persistence
        function saveData() {
            try {
                localStorage.setItem('crmContacts', JSON.stringify(contacts));
                localStorage.setItem('crmTasks', JSON.stringify(tasks));
                localStorage.setItem('crmDeals', JSON.stringify(deals));
                localStorage.setItem('crmContactId', currentContactId.toString());
                localStorage.setItem('crmTaskId', currentTaskId.toString());
                localStorage.setItem('crmDealId', currentDealId.toString());
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('Error saving data. Storage may be full.', 'error');
            }
        }

        function loadData() {
            try {
                contacts = JSON.parse(localStorage.getItem('crmContacts') || '[]');
                tasks = JSON.parse(localStorage.getItem('crmTasks') || '[]');
                deals = JSON.parse(localStorage.getItem('crmDeals') || '[]');
                currentContactId = parseInt(localStorage.getItem('crmContactId') || '1');
                currentTaskId = parseInt(localStorage.getItem('crmTaskId') || '1');
                currentDealId = parseInt(localStorage.getItem('crmDealId') || '1');
            } catch (error) {
                console.error('Error loading data:', error);
                contacts = [];
                tasks = [];
                deals = [];
                currentContactId = 1;
                currentTaskId = 1;
                currentDealId = 1;
            }
        }

        // Dashboard updates
        function updateDashboard() {
            document.getElementById('total-contacts').textContent = contacts.length;
            document.getElementById('total-leads').textContent = contacts.filter(c => c.status === 'lead').length;
            document.getElementById('total-customers').textContent = contacts.filter(c => c.status === 'customer').length;
            document.getElementById('total-tasks').textContent = tasks.filter(t => !t.completed).length;
            document.getElementById('total-deals').textContent = deals.filter(d => !['closed-won', 'closed-lost'].includes(d.stage)).length;
            
            const totalValue = deals.filter(d => !['closed-won', 'closed-lost'].includes(d.stage))
                .reduce((sum, deal) => sum + deal.value, 0);
            document.getElementById('total-deal-value').textContent = ' + totalValue.toLocaleString();
            
            updateRecentActivity();
        }

        function updateRecentActivity() {
            const activityContainer = document.getElementById('recent-activity');
            const recentItems = [];
            
            // Recent contacts
            const recentContacts = contacts.slice(-3).reverse();
            recentContacts.forEach(contact => {
                recentItems.push({
                    type: 'contact',
                    text: `New contact added: ${contact.firstName} ${contact.lastName}`,
                    date: contact.dateAdded
                });
            });
            
            // Recent tasks
            const recentTasks = tasks.slice(-3).reverse();
            recentTasks.forEach(task => {
                recentItems.push({
                    type: 'task',
                    text: `Task created: ${task.title}`,
                    date: task.dateCreated
                });
            });
            
            // Recent deals
            const recentDeals = deals.slice(-3).reverse();
            recentDeals.forEach(deal => {
                recentItems.push({
                    type: 'deal',
                    text: `Deal created: ${deal.title}`,
                    date: deal.dateCreated
                });
            });
            
            // Sort by date and take top 5
            recentItems.sort((a, b) => new Date(b.date) - new Date(a.date));
            const topItems = recentItems.slice(0, 5);
            
            if (topItems.length === 0) {
                activityContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>No recent activity</h3>
                        <p>Start by adding some contacts or creating tasks!</p>
                    </div>
                `;
                return;
            }
            
            activityContainer.innerHTML = topItems.map(item => `
                <div class="task-item">
                    <div class="task-content">
                        <div class="task-title">${item.text}</div>
                        <div class="task-meta">${new Date(item.date).toLocaleDateString()}</div>
                    </div>
                </div>
            `).join('');
        }

        // Contact display and filtering
        function updateContactsDisplay() {
            const grid = document.getElementById('contacts-grid');
            let displayContacts = [...contacts];
            
            // Apply filters
            const searchTerm = document.getElementById('search-contacts')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('status-filter')?.value || '';
            
            if (searchTerm) {
                displayContacts = displayContacts.filter(contact => 
                    contact.firstName.toLowerCase().includes(searchTerm) ||
                    contact.lastName.toLowerCase().includes(searchTerm) ||
                    contact.email.toLowerCase().includes(searchTerm) ||
                    (contact.company && contact.company.toLowerCase().includes(searchTerm))
                );
            }
            
            if (statusFilter) {
                displayContacts = displayContacts.filter(contact => contact.status === statusFilter);
            }
            
            if (displayContacts.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No contacts found</h3>
                        <p>Try adjusting your search or filters</p>
                        <button class="btn" onclick="showTab(event, 'add-contact')">Add Contact</button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = displayContacts.map(contact => `
                <div class="contact-card">
                    <h4>${contact.firstName} ${contact.lastName}</h4>
                    <div class="contact-info"><strong>Email:</strong> ${contact.email}</div>
                    <div class="contact-info"><strong>Phone:</strong> ${contact.phone || 'N/A'}</div>
                    <div class="contact-info"><strong>Company:</strong> ${contact.company || 'N/A'}</div>
                    <div class="contact-info"><strong>Position:</strong> ${contact.position || 'N/A'}</div>
                    <div class="contact-info"><strong>Status:</strong> <span style="text-transform: capitalize">${contact.status}</span></div>
                    ${contact.tags ? `<div class="contact-info"><strong>Tags:</strong> ${contact.tags}</div>` : ''}
                    ${contact.notes ? `<div class="contact-info"><strong>Notes:</strong> ${contact.notes}</div>` : ''}
                    <div class="contact-actions">
                        <button class="btn btn-secondary" onclick="editContact(${contact.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteContact(${contact.id})">Delete</button>
                        <button class="btn btn-success" onclick="createTaskForContact(${contact.id})">Add Task</button>
                    </div>
                </div>
            `).join('');
        }

        function filterContacts() {
            updateContactsDisplay();
        }

        function sortContacts() {
            const sortBy = document.getElementById('sort-contacts').value;
            
            switch(sortBy) {
                case 'name':
                    contacts.sort((a, b) => (a.firstName + a.lastName).localeCompare(b.firstName + b.lastName));
                    break;
                case 'company':
                    contacts.sort((a, b) => (a.company || '').localeCompare(b.company || ''));
                    break;
                case 'date':
                    contacts.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
                    break;
                case 'status':
                    contacts.sort((a, b) => a.status.localeCompare(b.status));
                    break;
            }
            
            updateContactsDisplay();
        }

        // Task display and filtering
        function updateTasksDisplay() {
            const tasksList = document.getElementById('tasks-list');
            let displayTasks = [...tasks];
            
            // Apply filters
            const filter = document.getElementById('task-filter')?.value || 'all';
            const today = new Date().toDateString();
            
            switch(filter) {
                case 'pending':
                    displayTasks = displayTasks.filter(task => !task.completed);
                    break;
                case 'completed':
                    displayTasks = displayTasks.filter(task => task.completed);
                    break;
                case 'overdue':
                    displayTasks = displayTasks.filter(task => 
                        !task.completed && task.dueDate && new Date(task.dueDate) < new Date()
                    );
                    break;
                case 'today':
                    displayTasks = displayTasks.filter(task => 
                        task.dueDate && new Date(task.dueDate).toDateString() === today
                    );
                    break;
            }
            
            if (displayTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <h3>No tasks found</h3>
                        <p>Create your first task to stay organized!</p>
                    </div>
                `;
                return;
            }
            
            // Sort by due date and priority
            displayTasks.sort((a, b) => {
                if (a.dueDate && b.dueDate) {
                    return new Date(a.dueDate) - new Date(b.dueDate);
                }
                return 0;
            });
            
            tasksList.innerHTML = displayTasks.map(task => {
                const contact = contacts.find(c => c.id == task.contactId);
                const deal = deals.find(d => d.id == task.dealId);
                const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && !task.completed;
                
                return `
                    <div class="task-item priority-${task.priority} ${task.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}">
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                            <div class="task-meta">
                                ${task.type.charAt(0).toUpperCase() + task.type.slice(1)} • 
                                Priority: ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                                ${task.dueDate ? ` • Due: ${new Date(task.dueDate).toLocaleDateString()}` : ''}
                                ${contact ? ` • Contact: ${contact.firstName} ${contact.lastName}` : ''}
                                ${deal ? ` • Deal: ${deal.title}` : ''}
                            </div>
                            ${task.description ? `<div style="margin-top: 5px; font-size: 0.9em;">${task.description}</div>` : ''}
                        </div>
                        <div class="task-actions">
                            <button class="btn ${task.completed ? 'btn-warning' : 'btn-success'}" 
                                onclick="toggleTask(${task.id})">
                                ${task.completed ? 'Reopen' : 'Complete'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteTask(${task.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterTasks() {
            updateTasksDisplay();
        }

        // Deal display
        function updateDealsDisplay() {
            const dealsList = document.getElementById('deals-list');
            
            if (deals.length === 0) {
                dealsList.innerHTML = `
                    <div class="empty-state">
                        <h3>No deals yet</h3>
                        <p>Create your first deal to track your sales pipeline!</p>
                    </div>
                `;
                return;
            }
            
            // Sort by stage and date
            const sortedDeals = [...deals].sort((a, b) => {
                const stageOrder = ['lead', 'qualified', 'proposal', 'negotiation', 'closed-won', 'closed-lost'];
                return stageOrder.indexOf(a.stage) - stageOrder.indexOf(b.stage);
            });
            
            dealsList.innerHTML = sortedDeals.map(deal => {
                const contact = contacts.find(c => c.id == deal.contactId);
                
                return `
                    <div class="deal-card">
                        <div class="deal-stage stage-${deal.stage}">${deal.stage.replace('-', ' ').toUpperCase()}</div>
                        <h4>${deal.title}</h4>
                        <div style="margin-bottom: 10px;">
                            <strong>Value:</strong> ${deal.value.toLocaleString()} • 
                            <strong>Probability:</strong> ${deal.probability}%
                        </div>
                        ${contact ? `<div><strong>Contact:</strong> ${contact.firstName} ${contact.lastName}</div>` : ''}
                        ${deal.closeDate ? `<div><strong>Expected Close:</strong> ${new Date(deal.closeDate).toLocaleDateString()}</div>` : ''}
                        ${deal.description ? `<div style="margin-top: 10px;">${deal.description}</div>` : ''}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="editDeal(${deal.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteDeal(${deal.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Analytics
        function updateAnalytics() {
            // Conversion rate
            const leads = contacts.filter(c => c.status === 'lead').length;
            const customers = contacts.filter(c => c.status === 'customer').length;
            const conversionRate = leads > 0 ? ((customers / (leads + customers)) * 100).toFixed(1) : 0;
            document.getElementById('conversion-rate').textContent = conversionRate + '%';
            
            // Average deal value
            const avgDealValue = deals.length > 0 ? 
                deals.reduce((sum, deal) => sum + deal.value, 0) / deals.length : 0;
            document.getElementById('avg-deal-value').textContent = ' + Math.round(avgDealValue).toLocaleString();
            
            // Tasks completion rate
            const completedTasks = tasks.filter(t => t.completed).length;
            const taskCompletionRate = tasks.length > 0 ? 
                ((completedTasks / tasks.length) * 100).toFixed(1) : 0;
            document.getElementById('tasks-completed').textContent = taskCompletionRate + '%';
            
            // Deal win rate
            const closedDeals = deals.filter(d => ['closed-won', 'closed-lost'].includes(d.stage));
            const wonDeals = deals.filter(d => d.stage === 'closed-won').length;
            const winRate = closedDeals.length > 0 ? 
                ((wonDeals / closedDeals.length) * 100).toFixed(1) : 0;
            document.getElementById('deals-won').textContent = winRate + '%';
        }

        // Utility functions
        function populateContactSelects() {
            const taskContactSelect = document.getElementById('task-contact');
            const dealContactSelect = document.getElementById('deal-contact');
            
            if (taskContactSelect) {
                taskContactSelect.innerHTML = '<option value="">Select Contact</option>' +
                    contacts.map(contact => 
                        `<option value="${contact.id}">${contact.firstName} ${contact.lastName}</option>`
                    ).join('');
            }
            
            if (dealContactSelect) {
                dealContactSelect.innerHTML = '<option value="">Select Contact</option>' +
                    contacts.map(contact => 
                        `<option value="${contact.id}">${contact.firstName} ${contact.lastName}</option>`
                    ).join('');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Action functions
        function editContact(id) {
            const contact = contacts.find(c => c.id === id);
            if (!contact) return;
            
            // Pre-fill form with contact data
            document.getElementById('firstName').value = contact.firstName;
            document.getElementById('lastName').value = contact.lastName;
            document.getElementById('email').value = contact.email;
            document.getElementById('phone').value = contact.phone || '';
            document.getElementById('linkedin').value = contact.linkedin || '';
            document.getElementById('company').value = contact.company || '';
            document.getElementById('position').value = contact.position || '';
            document.getElementById('status').value = contact.status;
            document.getElementById('source').value = contact.source || '';
            document.getElementById('tags').value = contact.tags || '';
            document.getElementById('notes').value = contact.notes || '';
            
            // Remove the contact from array (will be re-added when form is submitted)
            contacts = contacts.filter(c => c.id !== id);
            saveData();
            
            // Switch to add contact tab
            showTab({ target: document.querySelector('.nav-tab[onclick*="add-contact"]') }, 'add-contact');
            showNotification('Contact loaded for editing', 'success');
        }

        function deleteContact(id) {
            if (confirm('Are you sure you want to delete this contact?')) {
                contacts = contacts.filter(c => c.id !== id);
                saveData();
                updateDashboard();
                updateContactsDisplay();
                populateContactSelects();
                showNotification('Contact deleted successfully', 'success');
            }
        }

        function createTaskForContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            // Pre-select the contact in task form
            showTab({ target: document.querySelector('.nav-tab[onclick*="tasks"]') }, 'tasks');
            setTimeout(() => {
                document.getElementById('task-contact').value = contactId;
                document.getElementById('task-title').value = `Follow up with ${contact.firstName} ${contact.lastName}`;
            }, 100);
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                saveData();
                updateDashboard();
                updateTasksDisplay();
                showNotification(task.completed ? 'Task completed!' : 'Task reopened!', 'success');
            }
        }

        function deleteTask(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(t => t.id !== id);
                saveData();
                updateDashboard();
                updateTasksDisplay();
                showNotification('Task deleted successfully', 'success');
            }
        }

        function editDeal(id) {
            const deal = deals.find(d => d.id === id);
            if (!deal) return;
            
            // Pre-fill form with deal data
            document.getElementById('deal-title').value = deal.title;
            document.getElementById('deal-contact').value = deal.contactId;
            document.getElementById('deal-value').value = deal.value;
            document.getElementById('deal-stage').value = deal.stage;
            document.getElementById('deal-probability').value = deal.probability;
            document.getElementById('deal-close-date').value = deal.closeDate || '';
            document.getElementById('deal-description').value = deal.description || '';
            
            // Remove the deal from array (will be re-added when form is submitted)
            deals = deals.filter(d => d.id !== id);
            saveData();
            
            showNotification('Deal loaded for editing', 'success');
        }

        function deleteDeal(id) {
            if (confirm('Are you sure you want to delete this deal?')) {
                deals = deals.filter(d => d.id !== id);
                saveData();
                updateDashboard();
                updateDealsDisplay();
                showNotification('Deal deleted successfully', 'success');
            }
        }

        function exportContacts() {
            if (contacts.length === 0) {
                showNotification('No contacts to export', 'error');
                return;
            }
            
            const csvContent = [
                ['First Name', 'Last Name', 'Email', 'Phone', 'Company', 'Position', 'Status', 'Source', 'Tags', 'Notes', 'Date Added'],
                ...contacts.map(contact => [
                    contact.firstName,
                    contact.lastName,
                    contact.email,
                    contact.phone || '',
                    contact.company || '',
                    contact.position || '',
                    contact.status,
                    contact.source || '',
                    contact.tags || '',
                    contact.notes || '',
                    new Date(contact.dateAdded).toLocaleDateString()
                ])
            ].map(row => row.join(',')).join('\n');
            
            downloadCSV(csvContent, 'contacts.csv');
            showNotification('Contacts exported successfully!', 'success');
        }

        function exportData() {
            const data = {
                contacts,
                tasks,
                deals,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `crm_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Data exported successfully!', 'success');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('crmDarkMode', isDark);
            showNotification(`${isDark ? 'Dark' : 'Light'} mode enabled!`, 'success');
        }
    </script>
</body>
</html>
